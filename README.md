# Measurement noise scaling laws

This repo contains code to reproduce the results from our [paper introducing measurement noise scaling laws.](https://arxiv.org/abs/2503.02726). Below we provide some tips for navigating the repository.

A lot of this code (all of the single-cell infrastructure) was written by [Igor Sadalski](https://github.com/igor-sadalski/Scaling-up-measurement-noise-scaling-laws).

We also provide a [paper website](https://ggdna.github.io/noise-scaling/) which includes an interactive "scaling zoo" where you can explore all the noise scaling curves we observed in this work.

## Figure --> source data mapping

The main figure containing all empirical results (Figure 2) is generated by [analysis/big_fig_2.ipynb](analysis/big_fig_2.ipynb). Below is a mapping of figure panels to their source data:

### Cell number scaling Collapse (panel b)
- **data**: single-cell results from `collect_mi_results.csv`
- **scaling parameters**: computed in `analysis/cell_scaling_number_find_hyperparams.py`, and saved in `analysis/final_results/cell_scaling...`

### Noise scaling curves (panel c)
- **data**: single-cell results from `collect_mi_results.csv`
- **parameters**: computed in notebook, also given in `analysis/final_results/scaling_plots*.csv`

### Universal noise scaling collapse (panel e)
- **data**:
  - Single-cell: `collect_mi_results.csv`
  - TissueMNIST: [images/tissuemnist_models/result_*.csv](images/tissuemnist_models/)
  - Protein sequences: [seq/multisize_gisaid_results.csv](seq/multisize_gisaid_results.csv)
  - Caltech101: [images/caltech101/*.csv](images/caltech101)
- **parameters**: computed in notebook

### Parameter comparison (panel f)
- **data**: [analysis/final_results/scaling_plots*.csv](analysis/final_results/scaling_plots_u_bar_138.109_I_max_1.419.csv)

### Generalization (panels g-i)
- **protein sequences**: [seq/multisize_gisaid_results.csv](seq/multisize_gisaid_results.csv)
- **Kidney cortex pixel downsampling**: [images/tissuemnist_models/result_pix_*.csv](images/tissuemnist_models/)
- **Kidney cortex gaussian noise**: [images/tissuemnist_models/result_gauss_*.csv](images/tissuemnist_models/)

## Fitting and evaluating models for scaling analyses

### Single-cell experiments

The single-cell experiments use four datasets (each corresponding to a different auxiliary-MI metric):

| Script | Dataset | Biological Signals |
|--------|---------|-------------------|
| [run_larry_whole.py](run_larry_whole.py) | Weinreb et al., 2020 | Clone |
| [run_merfish_whole.py](run_merfish_whole.py) | Vizgen data release | Spatial |
| [run_pbmc_whole.py](run_pbmc_whole.py) | Hao et al., 2021 | Protein |
| [run_shendure_whole.py](run_shendure_whole.py) | Qiu et al. | Temporal |

Each script:
1. prepares data at various cell numbers and UMI downsampling levels
2. trains embedding models (PCA, SCVI, Geneformer, Random Projection)
3. computes mutual information between embeddings and biological signals

### TissueMNIST image experiments

Located in [images/](images/):

- [run_kidney_experiment.py](images/run_kidney_experiment.py): fit a model with pixel downsampling or Gaussian noising process
- [submit_kidney_experiments.sh](images/submit_kidney_experiments.sh): SLURM batching

### Caltech101 image experiments

Located in [images/caltech101]. One notebook for each noising process, one results .csv for each.

### Protein sequence experiments

Located in [seq/](seq/):

- [gisaid_preprocessing.ipynb](seq/gisaid_preprocessing.ipynb): Parse and tokenize GISAID spike protein sequences
- [train_gisaid_model.py](seq/train_gisaid_model.py): Fine-tune ESM2 models on noised sequences
- [submit_all_gisaid_jobs.sh](seq/submit_all_gisaid_jobs.sh): SLURM batching

## Core infrastructure for single-cell scaling experiments

The [scaling_laws/](scaling_laws/) package provides:

### Data prep (`scaling_laws/prepare/`)
- [data.py](scaling_laws/scaling_laws/prepare/data.py): Experiment and dataset classes for dataset management, downsampling, and tokenization

### Representation learning models (`scaling_laws/algo/`)
- [abc.py](scaling_laws/scaling_laws/algo/abc.py): `BaseAlgorithm` abstract class
- [pca.py](scaling_laws/scaling_laws/algo/pca.py): PCA embeddings
- [scvi.py](scaling_laws/scaling_laws/algo/scvi.py): scVI variational autoencoder
- [geneformer.py](scaling_laws/scaling_laws/algo/geneformer.py): Geneformer transformer
- [rp.py](scaling_laws/scaling_laws/algo/rp.py): Random projection baseline


### Installation

```bash
python3.10 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# Install Geneformer
cd Geneformer
pip install -e .

# Install scaling_laws package
cd ../scaling_laws
pip install -e .
```

## Miscellaneous analysis code

| Notebook | Purpose |
|----------|---------|
| [analysis/cell_number_scaling.ipynb](analysis/cell_number_scaling.ipynb) | cell number scaling analysis (supplement) |
| [analysis/cell_scaling_find_hyperparams.py](analysis/cell_scaling_find_hyperparams.py) | fit params for cell number scaling |
| [analysis/noise_scaling_find_hyperparams.py](analysis/noise_scaling_find_hyperparams.py) | fit params for noise scaling |
| [analysis/centralized_vis.ipynb](analysis/centralized_vis.ipynb) | my lil bokeh plot :) |
| [analysis/comparisons.ipynb](analysis/comparisons.ipynb) | comparing benefits of noise and cell number improvement |
| [analysis/model_fit_quality.ipynb](analysis/model_fit_quality.ipynb) | fit quality assessment |

